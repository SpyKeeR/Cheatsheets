# Utilisateurs & groupes M365
- Types utilisateurs : cloud-only, synchronisé (Azure AD Connect), with/without password sync.  
- Création : Admin Center (UI), CSV (bulk), PowerShell, Azure AD Connect.  
- RBAC : utiliser rôles prédéfinis ou personnalisés pour délégation.  
- Groupes :
  - Distribution (mailing),
  - Microsoft 365 (collab : SharePoint, Teams, mailbox),
  - Security (accès ressources),
  - Dynamic groups (règles).  
- Rôles groupe : Owner (gestion), Member (utilisation), Guest (externe, droits limités).

## Bonnes pratiques RBAC
- Comptes d’administration dédiés sans licence utilisateur standard.  
- Limiter Administrateurs globaux (1–2).  
- Déléger via rôles spécifiques (User Admin, License Admin, Helpdesk, Exchange, Teams, Security...).

## Entra Connect (Azure AD Connect)
- Sync AD local → Entra ID ; writeback optionnel (pwd reset, group writeback).  
- Étapes : ajouter suffixe UPN, aligner UPNs, compte service dédié, installer assistant, vérifier DNS.  
- Sync cycle : auto toutes les 30 min ; manuel : `Start-ADSyncSyncCycle -PolicyType Delta` (ou Initial).  
- Outils : Synchronization Service Manager, Rules Editor.

# Exchange Online

## Plans (licences BAL)
- Plan 1 : 50 Go boîte + archivage 50 Go.  
- Plan 2 : 100 Go boîte + archivage extensible (auto-expansion).

## Types de BAL
- User mailbox : envoi/réception, délégation, règles.  
- Shared mailbox : multi-accès, sans licence (conditions).  
- Resource mailbox : Room / Equipment (`New-Mailbox -Room` / `-Equipment`).  
- Contacts & MailUsers : externe (contact) vs externe auth (mail user).  
- Groupes : Distribution / Microsoft365 (collab) / Security / Dynamic.

## Validation & DNS
- Validation domaine M365 : ajouter `TXT MS=MS=xxxxxxxxxxxx` dans zone DNS publique.  
- Enregistrements essentiels DNS : `SOA`, `NS`, `A/AAAA`, `SRV` (ex: `_kerberos._tcp`), `MX` (réception), `TXT` (SPF).

## Flux mail & rôles
- MUA = client utilisateur (Outlook, Thunderbird, mobile).  
- MSA = Mail Submission Agent : reçoit du MUA, authentifie, transmet au MTA.  
- MTA = Mail Transfer Agent : transporte entre serveurs.  
- MDA = Mail Delivery Agent : dépose dans boîte utilisateur.

## Domaines & réception
- Domaine accepté = domaine géré par le tenant (ne pas ajouter domaines publics tiers).  
- Relais interne / connecteurs si transfert vers autre infrastructure ou appar. tiers.

## Suivi & règles
- Message trace = dépannage (expéditeur/destinataire/objet, pas contenu).  
- Transport Rules = conditions/actions/exceptions ; priorité = ordre (éviter chevauchements).  
- Connecteurs = lier on-prem ↔ Exchange Online, autoriser équipements métier (copieurs).

## Authentification clients & protocoles
- Outlook desktop = MAPI over HTTPS.  
- Mobiles = ActiveSync.  
- IMAP (sync multi-appareils) / POP (déconseillé).  
- Autodiscover DNS : `CNAME autodiscover → autodiscover.outlook.com` → config automatique Outlook.

## Auth & sécurité mail
- SPF (TXT) : `v=spf1 include:spf.protection.outlook.com -all` → autorise Exchange Online à envoyer pour le domaine.  
- DKIM: activer via M365 → publier CNAMEs, signe messages.  
- DMARC: politique `p=none|quarantine|reject` + rapports (aggregate/forensic).  
- Recommandation = SPF + DKIM + DMARC.

## Ports essentiels
| Service | Port non sécurisé | Port sécurisé |
|---|---:|---:|
| HTTP/HTTPS | 80 | 443 |
| POP3 | 110 | 995 |
| IMAP4 | 143 | 993 |
| MAPI/HTTPS | — | 443 |
| ActiveSync/HTTPS | — | 443 |
| SMTP (serveur) | 25 | — |
| SMTP submission | 2525 | 587 / 465 |

# Intune (MDM)
- Modèles BYOD / CYOD / COPE (choix selon contrôle vs liberté).  
- DNS Intune : `CNAME EnterpriseEnrollment → EnterpriseEnrollment.manage.microsoft.com` ; `CNAME EnterpriseRegistration → EnterpriseRegistration.windows.net`.  
- Enrollment méthodes :
  - Paramètres Système → "Accès professionnel ou scolaire" (S’inscrire).  
  - App "Portail d’entreprise" → autoriser gestion org.  
- Groupes dynamiques (appareils) via règles (ex: `deviceOSVersion StartsWith '10.0.2'`).  
- WIP (Windows Information Protection) → protéger données apps pro vs perso.  
- Profils & politiques : mot de passe, chiffrement, effacement, verrouillage, interdiction supports amovibles.  
- Suivi déploiement & logs depuis console Intune.

## SharePoint & OneDrive
- OneDrive = stockage perso (1–5 To selon licence).  
- SharePoint = sites, bibliothèques, co-édition ; org: 1 TB + 10 GB/licence ; site max 25 TB.  
- Contrôle création sites → restreindre si nécessaire pour gouvernance.

## Teams & gouvernance
- Teams Admin Center pour gérer créations, confidentialité et politiques.  
- Limiter création d’équipes : créer groupe d’autorisation + script PowerShell pour restreindre.

## Menaces & mesures
- Menaces : spam, phishing, spear-phishing, malware, scam, usurpation, account takeover.  
- Mesures : EOP/ATP + sensibilisation + MFA + revue DNS + sauvegarde tierce (Veeam, Skykick).  
- MFA : config via Entra ID, app Authenticator recommandée.

## Sauvegarde & solutions tierces
- Microsoft ne fournit pas sauvegarde complète illimitée : envisager Veeam/Skykick/Datto.  
- Utiliser solutions tierces pour restauration point-in-time, sauvegarde mail/SharePoint/OneDrive.

# PowerShell — M365 & administration

## Installation & connexion
- Installer module moderne : `Install-Module Microsoft.Graph -Scope CurrentUser`  
- Connexion Graph : `Connect-MgGraph -Scopes "Directory.AccessAsUser.All","RoleManagement.ReadWrite.Directory"` (ajouter scopes selon besoins).  
- Modules encore utiles : SharePoint (`PnP.PowerShell`), Exchange (`ExchangeOnlineManagement`), Teams (`MicrosoftTeams`), Compliance (`ExchangeOnlineManagement`/IPPSSession).

## Equivalences & astuces
- MSOnline → Microsoft.Graph : `Connect-MsolService` → `Connect-MgGraph -Scopes "User.ReadWrite.All"`, `Get-MsolUser` → `Get-MgUser`, `New-MsolUser` → `New-MgUser`.  
- Installer sous-modules : `Install-Module Microsoft.Graph.Users` etc.  
- Trouver cmdlets Graph : `Find-MgGraphCommand -Command restore`.

## Gestion utilisateurs & rôles
- Créer user : `New-MgUser -AccountEnabled -DisplayName "Jean Petit" -UserPrincipalName "jpetit@dom" -MailNickname "jpetit" -PasswordProfile @{Password="Pwd";ForceChangePasswordNextSignIn=$true}` 
- Liste params : `Get-MgUser -UserId <id> | Select-Object *`
- Forcer mot de passe & update : créer `PasswordProfile` puis `Update-MgUser -UserId <id> -PasswordProfile $PasswordProfile`  
- Désactiver expiration password (cloud-only) : `Update-MgUser -UserId <id> -PasswordPolicies "DisablePasswordExpiration"` (réversible à "None").
- Supprimer user : `Remove-MgUser -UserId "jpetit@dom"` / restaurer : `Restore-MgDirectoryDeletedItem -DirectoryObjectId <ID>`  
- Lister templates rôles : `Get-MgDirectoryRoleTemplate` → activer : `Enable-MgDirectoryRole -RoleTemplateId <id>`  
- Ajouter membre rôle : `New-MgDirectoryRoleMemberByRef -DirectoryRoleId <RoleId> -BodyParameter @{ "@odata.id" = "https://graph.microsoft.com/v1.0/users/<UserId>" }`  
- Lister rôles d’un user : `Get-MgUserAppRoleAssignment -UserId <UserId>`

## PowerShell / licensing
- Installer module : `Install-Module Microsoft.Graph -Scope CurrentUser`  
- Connexion : `Connect-MgGraph -Scopes "User.ReadWrite.All","Organization.Read.All"`  
- Lister SKU : `Get-MgSubscribedSku`  
- Attribuer licence : `Set-MgUserLicense -UserId "user@ex" -AddLicenses @{ SkuId="sku-guid" }`  
- Retirer licence : `Set-MgUserLicense -UserId "user@ex" -RemoveLicenses @("sku-guid")`  
- Batch : `Get-MgUser -Filter "Department eq 'X'" | ForEach-Object { Set-MgUserLicense -UserId $_.Id -AddLicenses @{ SkuId="sku-id" } }`

## Exchange — commandes utiles
- Créer shared : `New-Mailbox –Shared –Name "support" –Alias "support"`  
- Quotas : `Set-Mailbox –Identity "Jean" –IssueWarningQuota 49gb –ProhibitSendQuota 49.5gb –ProhibitSendReceiveQuota 50gb`  
- Retention/soft-delete : `Set-Mailbox –Identity "Jean" –RetainDeletedItemsFor 30` / `Get-Mailbox -SoftDeletedMailbox`  
- Archivage & litigation : activer via PowerShell (cmdlets Exchange).

## Déploiement Office (ODT)
- Préparer partage réseau, extraire ODT, créer XML via config.office.com.  
- `setup.exe /download` (récup), `setup.exe /configure` (install via XML).  
- GPO : script de démarrage `setup.exe /configure` sur OU cible, admin local requis sur postes.