# ☁️ Microsoft 365 — Aide-mémoire

## 👤 Entra ID (Azure AD) — Identity & Access

### Types d'Identités
| Type | Description | Sync | Use Case |
|------|-------------|------|----------|
| **Cloud-only** | Créé dans Entra ID | Non | Organisation cloud-native |
| **Synchronized** | AD local → Entra ID | Oui | Environnement hybride |
| **Federated** | Auth via AD FS/SAML | Oui | SSO complexe |
| **Guest** | Utilisateur externe | Non | Collaboration B2B |

### Gestion Utilisateurs
```powershell
# Création utilisateur
New-MgUser -AccountEnabled -DisplayName "Jean Dupont" -UserPrincipalName "jdupont@domain.com" -MailNickname "jdupont" -PasswordProfile @{Password="TempPass123!";ForceChangePasswordNextSignIn=$true}

# Gestion licences
Get-MgSubscribedSku  # Lister SKU disponibles
Set-MgUserLicense -UserId "jdupont@domain.com" -AddLicenses @{SkuId="sku-guid"}
Set-MgUserLicense -UserId "jdupont@domain.com" -RemoveLicenses @("sku-guid")

# Désactiver expiration mot de passe (cloud-only)
Update-MgUser -UserId "jdupont@domain.com" -PasswordPolicies "DisablePasswordExpiration"
```

### Types de Groupes
- **Distribution** : Mailing lists classiques
- **Microsoft 365** : Collaboration (SharePoint, Teams, mailbox partagée)
- **Security** : Contrôle d'accès aux ressources
- **Dynamic** : Adhésion basée sur règles automatiques
- **Role-assignable** : Peut recevoir des rôles Entra ID

### RBAC — Roles & Permissions
```
Administrateurs recommandés (principe du moindre privilège) :
├── Global Administrator (1-2 comptes max)
├── User Administrator (gestion utilisateurs)
├── License Administrator (attribution licences)
├── Helpdesk Administrator (réinitialisation MDP)
├── Exchange Administrator (gestion Exchange)
├── Teams Administrator (gestion Teams)
├── Security Administrator (politiques sécurité)
└── Compliance Administrator (conformité)
```

### Entra Connect (Hybrid Identity)
```bash
# Prérequis synchronisation
1. Suffixe UPN ajouté dans AD local
2. UPN alignés avec domaines M365
3. Compte service dédié (non-expiration)
4. Serveur dédié ou VM
5. Connectivité HTTPS sortante

# Cycle de synchronisation
Start-ADSyncSyncCycle -PolicyType Delta    # Incrémental (30min auto)
Start-ADSyncSyncCycle -PolicyType Initial  # Complet
```

## 📧 Exchange Online

### Types de Boîtes aux Lettres
| Type | Description | Licence | Accès |
|------|-------------|---------|-------|
| **User Mailbox** | BAL utilisateur standard | Oui | Propriétaire + délégués |
| **Shared Mailbox** | BAL partagée équipe | Non* | Membres avec permissions |
| **Resource Mailbox** | Salle/équipement | Non | Réservation automatique |
| **Archive Mailbox** | Archivage long terme | Plan 2 | Utilisateur propriétaire |

*Gratuite si <50GB et utilisateurs ont licence Exchange

### Plans Exchange Online
- **Plan 1** : 50GB boîte + 50GB archive
- **Plan 2** : 100GB boîte + archive auto-extensible + Compliance avancée

### Configuration DNS Essentielle
```dns
# Domaine validation
TXT @ "MS=ms12345678"

# Exchange Online
MX @ "domain-com.mail.protection.outlook.com" (priorité 0)
CNAME autodiscover "autodiscover.outlook.com"

# Sécurité email
TXT @ "v=spf1 include:spf.protection.outlook.com -all"
CNAME selector1._domainkey "selector1-domain-com._domainkey.domain.onmicrosoft.com"
TXT _dmarc "v=DMARC1; p=quarantine; rua=mailto:dmarc@domain.com"
```

### Gestion Boîtes Partagées
```powershell
# Créer boîte partagée
New-Mailbox -Shared -Name "Support IT" -Alias "support-it"

# Ajouter permissions
Add-MailboxPermission -Identity "support-it" -User "jdupont@domain.com" -AccessRights FullAccess
Add-RecipientPermission -Identity "support-it" -Trustee "jdupont@domain.com" -AccessRights SendAs

# Configuration quotas
Set-Mailbox -Identity "jdupont@domain.com" -IssueWarningQuota 49GB -ProhibitSendQuota 49.5GB -ProhibitSendReceiveQuota 50GB
```

### Sécurité Email (SPF/DKIM/DMARC)
- **SPF** : Autorise servers à envoyer pour le domaine
- **DKIM** : Signature cryptographique des messages  
- **DMARC** : Politique de traitement des échecs SPF/DKIM
- **Recommandation** : Implémenter les 3 pour protection optimale

### Ports & Protocoles
| Service | Port Standard | Port Sécurisé | Usage |
|---------|---------------|---------------|-------|
| **HTTPS/MAPI** | — | 443 | Outlook desktop |
| **ActiveSync** | — | 443 | Mobiles/tablettes |
| **IMAP4** | 143 | 993 | Clients tiers |
| **POP3** | 110 | 995 | Clients basiques |
| **SMTP** | 25/587 | 465/587 | Envoi/relay |

## 🤝 Microsoft Teams

### Administration Teams
```
Teams Admin Center → Contrôle :
├── Création d'équipes (autoriser/restreindre)
├── Politiques de messagerie
├── Politiques de réunion
├── Applications autorisées
├── Numérotation (téléphonie)
└── Compliance & rétention
```

### Gouvernance Teams
- **Limitation création** : Restreindre à un groupe d'utilisateurs autorisés
- **Naming Policy** : Convention nommage automatique
- **Expiration Groups** : Suppression auto si inactifs
- **Classification** : Étiquetage sensibilité (Public/Private/Highly Confidential)

## 🛡️ Sécurité & Compliance

### Multi-Factor Authentication (MFA)
```
Configuration MFA :
├── Entra ID → Security → MFA
├── Méthodes : App Authenticator (recommandé), SMS, Appel
├── Conditional Access : Règles contextuelles
└── Per-user MFA : Configuration individuelle (legacy)
```

### Conditional Access Policies
```
Règles courantes :
├── Bloquer pays à risque
├── Exiger MFA hors réseau corporate
├── Bloquer clients legacy (Basic Auth)
├── Exiger appareils conformes/joints
└── Contrôle session (Cloud App Security)
```

### Microsoft Defender for Office 365
- **Plan 1** : Safe Attachments, Safe Links, Anti-phishing
- **Plan 2** : + Threat Investigation, Attack Simulation, Automated Response

### Compliance & Data Loss Prevention
```
Fonctionnalités Compliance :
├── Retention Policies (conservation données)
├── Data Loss Prevention (DLP)
├── Information Protection (étiquetage)
├── Insider Risk Management
├── Communication Compliance
└── eDiscovery (Advanced eDiscovery Plan 2)
```

## 📱 Microsoft Intune (MDM/MAM)

### Modèles de Déploiement
- **BYOD** : Bring Your Own Device (appareil personnel)
- **CYOD** : Choose Your Own Device (choix dans catalogue)
- **COPE** : Corporate Owned, Personally Enabled (propriété entreprise, usage mixte)

### Configuration DNS Intune
```dns
CNAME EnterpriseEnrollment "EnterpriseEnrollment.manage.microsoft.com"
CNAME EnterpriseRegistration "EnterpriseRegistration.windows.net"
```

### Enrollment Methods
1. **Settings** → "Accès professionnel ou scolaire" → S'inscrire
2. **Company Portal App** → Autoriser gestion organisation
3. **Autopilot** : Provisioning automatique (Windows)
4. **Apple DEP/ADE** : Enrollment iOS/macOS géré

### Policies Types
- **Configuration Profiles** : Paramètres appareil (Wi-Fi, VPN, certificats)
- **Compliance Policies** : Exigences sécurité (chiffrement, PIN, jailbreak)
- **App Protection** : Gestion données apps (copier/coller, sauvegarde)
- **Windows Information Protection** : Séparation données pro/perso

## 📁 SharePoint Online & OneDrive

### Capacités Stockage
- **OneDrive** : 1TB par défaut, jusqu'à 5TB selon licence
- **SharePoint** : 1TB + 10GB par licence utilisateur
- **Site Collection** : Maximum 25TB par site

### Gouvernance SharePoint
```
Contrôles recommandés :
├── Limitation création sites (groupe autorisé)
├── Classifications sites (Public/Internal/Confidential)
├── Retention policies par type contenu
├── External sharing restrictions
└── DLP policies pour documents sensibles
```

## ⚡ PowerShell pour M365

### Modules Essentiels
```powershell
# Installation modules modernes
Install-Module Microsoft.Graph -Scope CurrentUser
Install-Module PnP.PowerShell -Scope CurrentUser
Install-Module ExchangeOnlineManagement -Scope CurrentUser
Install-Module MicrosoftTeams -Scope CurrentUser

# Connexions
Connect-MgGraph -Scopes "Directory.ReadWrite.All","User.ReadWrite.All"
Connect-ExchangeOnline -UserPrincipalName admin@domain.com
Connect-PnPOnline -Url "https://tenant.sharepoint.com" -Interactive
Connect-MicrosoftTeams
```

### Migration MSOnline → Microsoft.Graph
| MSOnline (Legacy) | Microsoft.Graph (Modern) |
|-------------------|--------------------------|
| `Connect-MsolService` | `Connect-MgGraph` |
| `Get-MsolUser` | `Get-MgUser` |
| `New-MsolUser` | `New-MgUser` |
| `Set-MsolUser` | `Update-MgUser` |
| `Get-MsolRole` | `Get-MgDirectoryRole` |

### Gestion Rôles Administration
```powershell
# Lister templates rôles
Get-MgDirectoryRoleTemplate

# Activer rôle
Enable-MgDirectoryRole -RoleTemplateId "role-template-id"

# Ajouter utilisateur à rôle
$params = @{
    "@odata.id" = "https://graph.microsoft.com/v1.0/users/user-id"
}
New-MgDirectoryRoleMemberByRef -DirectoryRoleId "role-id" -BodyParameter $params

# Lister rôles d'un utilisateur
Get-MgUserAppRoleAssignment -UserId "user-id"
```

### Bulk Operations
```powershell
# Attribution licence en masse
$users = Get-MgUser -Filter "Department eq 'Sales'"
foreach ($user in $users) {
    Set-MgUserLicense -UserId $user.Id -AddLicenses @{SkuId="sku-guid"}
}

# Création utilisateurs par CSV
$csv = Import-Csv "users.csv"
foreach ($row in $csv) {
    New-MgUser -AccountEnabled -DisplayName $row.DisplayName -UserPrincipalName $row.UPN -PasswordProfile @{Password=$row.Password;ForceChangePasswordNextSignIn=$true}
}
```

## 🚀 Déploiement Office

### Office Deployment Tool (ODT)
```xml
<!-- Configuration.xml exemple -->
<Configuration>
  <Add OfficeClientEdition="64" Channel="Current">
    <Product ID="O365ProPlusRetail">
      <Language ID="fr-fr" />
      <Language ID="en-us" />
      <ExcludeApp ID="Access" />
      <ExcludeApp ID="Publisher" />
    </Product>
  </Add>
  <Property Name="SharedComputerLicensing" Value="1" />
  <Property Name="FORCEAPPSHUTDOWN" Value="TRUE" />
  <Updates Enabled="TRUE" />
  <Display Level="None" AcceptEULA="TRUE" />
</Configuration>
```

```bash
# Déploiement ODT
setup.exe /download Configuration.xml    # Téléchargement
setup.exe /configure Configuration.xml   # Installation
```

### Group Policy Deployment
1. Créer partage réseau accessible par ordinateurs cibles
2. Script démarrage GPO : `\\server\share\setup.exe /configure \\server\share\configuration.xml`
3. Appliquer sur OU contenant ordinateurs cibles
4. Droits admin local requis sur postes

## 📊 Licensing & Plans

### Plans Principaux
| Plan | Exchange | SharePoint | Teams | Office Apps |
|------|----------|------------|-------|-------------|
| **Business Basic** | 50GB | 1TB | ✅ | Web only |
| **Business Standard** | 50GB | 1TB | ✅ | Desktop + Web |
| **Business Premium** | 50GB | 1TB | ✅ | Desktop + Intune |
| **E3** | 100GB | Unlimited | ✅ | Desktop + Compliance |
| **E5** | 100GB | Unlimited | ✅ | + Security + Analytics |

### Add-ons Importants
- **Exchange Online Plan 2** : Archive auto-extensible
- **Defender for Office 365** : Protection avancée email
- **Power BI Pro/Premium** : Analytics & reporting
- **Project/Visio** : Applications spécialisées

## 🛠️ Monitoring & Troubleshooting

### Service Health
```
Monitoring M365 :
├── Admin Center → Health → Service health
├── Message Center : Changements planifiés
├── Service requests : Support Microsoft
└── Usage Reports : Adoption services
```

### Outils Diagnostic
- **Microsoft Remote Connectivity Analyzer** : Test connectivité Exchange/Teams
- **Message Trace** : Suivi email (expéditeur/destinataire/objet)
- **Call Quality Dashboard** : Qualité appels Teams
- **Adoption Score** : Mesure adoption services M365

### Sauvegarde Tierce
⚠️ **Microsoft ne fournit pas de sauvegarde complète** pour récupération point-in-time

Solutions recommandées :
- **Veeam Backup for Microsoft 365**
- **SkyKick Cloud Backup**
- **Datto SaaS Protection**
- **Barracuda Cloud-to-Cloud Backup**

## 🔥 Incident Response & Recovery

### Compte Compromis
1. **Isoler** : Désactiver compte immédiatement
2. **Révoquer** : Sessions actives et tokens refresh
3. **Analyser** : Audit logs et activité suspecte
4. **Nettoyer** : Règles forwarding/delegates malveillants
5. **Sécuriser** : Nouveau MDP + MFA + monitoring renforcé

### Recovery Scenarios
- **Suppression accidentelle** : Corbeille utilisateur (30j) → Corbeille admin (93j)
- **Ransomware** : Isolation + restauration sauvegarde tierce
- **Perte accès admin** : Procédure break-glass Microsoft
- **Corruption données** : Point-in-time restore (sauvegarde tierce requise)