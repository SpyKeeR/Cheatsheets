# üíæ Stockage Linux ‚Äî Aide-m√©moire

## üèóÔ∏è Architecture Stockage Linux

### Stack de Stockage
```
Application
    ‚Üì
Filesystem (ext4, xfs, btrfs)
    ‚Üì
Block Device (/dev/sdX, /dev/mapper/*)
    ‚Üì
Volume Manager (LVM, mdadm)
    ‚Üì
Partition Table (MBR, GPT)
    ‚Üì
Physical Device (HDD, SSD, NVMe)
```

### Types de P√©riph√©riques
| Type | Convention | Exemple | Description |
|------|------------|---------|-------------|
| **IDE/PATA** | `/dev/hdX` | `/dev/hda1` | Legacy (rare) |
| **SCSI/SATA/USB** | `/dev/sdX` | `/dev/sda1` | Standard actuel |
| **NVMe** | `/dev/nvmeXnYpZ` | `/dev/nvme0n1p1` | SSD haute performance |
| **Virtual** | `/dev/vdX` | `/dev/vda1` | VM (KVM/Xen) |
| **Loop** | `/dev/loopX` | `/dev/loop0` | Fichiers mont√©s |
| **Device Mapper** | `/dev/mapper/*` | `/dev/mapper/vg-lv` | LVM, LUKS, RAID |

## üóÇÔ∏è Tables de Partitions

### Comparaison MBR vs GPT
| Aspect | MBR (Legacy) | GPT (Moderne) |
|--------|-------------|---------------|
| **Taille max disque** | 2.2 TiB | 9.4 ZiB |
| **Partitions primaires** | 4 max | 128 par d√©faut |
| **Partitions √©tendues** | 1 + logiques | Non n√©cessaire |
| **Boot** | BIOS | UEFI (+ BIOS legacy) |
| **Redondance** | Aucune | Header + backup |
| **Identifiants** | Types num√©riques | UUID + noms |

### Structure MBR
```
Secteur 0 (512 octets):
‚îú‚îÄ‚îÄ Boot Code (446 octets)
‚îú‚îÄ‚îÄ Partition Table (64 octets = 4√ó16 octets)
‚îî‚îÄ‚îÄ Signature (2 octets: 0x55AA)

Types de partitions courantes:
‚îú‚îÄ‚îÄ 0x83: Linux native
‚îú‚îÄ‚îÄ 0x8E: Linux LVM
‚îú‚îÄ‚îÄ 0x82: Linux swap
‚îî‚îÄ‚îÄ 0xEF: EFI System Partition
```

### Structure GPT
```
Secteur 0: Protective MBR (compatibilit√©)
Secteur 1: GPT Header
Secteurs 2-33: Partition Entries (128 entr√©es)
[Donn√©es partitions]
Secteurs -33 √† -2: Backup Partition Entries
Secteur -1: Backup GPT Header
```

## üîß Gestion Partitions

### Outils de Partitionnement
```bash
# fdisk (MBR/GPT, interface menu)
fdisk -l                     # Lister toutes partitions
fdisk /dev/sdb               # √âditer table partitions
   p  # Print table
   n  # New partition
   d  # Delete partition
   t  # Change partition type
   a  # Toggle bootable flag
   w  # Write changes
   q  # Quit without saving

# parted (GPT/MBR, ligne commande)
parted /dev/sdb print        # Afficher table
parted /dev/sdb mklabel gpt  # Cr√©er table GPT
parted /dev/sdb mkpart primary ext4 1MiB 100%  # Cr√©er partition
parted /dev/sdb rm 1         # Supprimer partition 1

# gdisk (GPT sp√©cialis√©)
gdisk /dev/sdb               # Interface similaire fdisk
```

### Repartitionnement en Ligne
```bash
# Redimensionner partition sans red√©marrage
growpart /dev/sda 2          # √âtendre partition 2 (cloud-utils)
resize2fs /dev/sda2          # √âtendre filesystem ext4
xfs_growfs /mount/point      # √âtendre filesystem XFS

# V√©rifier changements
lsblk                        # Arbre p√©riph√©riques blocs
cat /proc/partitions         # Kernel partition table
partprobe /dev/sdb           # Relire table partitions
```

## üì¶ LVM (Logical Volume Manager)

### Concepts LVM
```
Physical Volume (PV) ‚Üí Volume Group (VG) ‚Üí Logical Volume (LV)
       ‚Üì                      ‚Üì                     ‚Üì
   Disques/Parts         Pool storage        Volumes finaux
```

### Workflow Complet
```bash
# 1. Pr√©paration physique
fdisk /dev/sdb               # Cr√©er partition type 8E (LVM)
# ou utiliser disque entier sans partitionnement

# 2. Initialisation Physical Volumes
pvcreate /dev/sdb1 /dev/sdc1 # Cr√©er PV sur partitions
pvcreate /dev/sdd            # Ou sur disque entier

# 3. Cr√©ation Volume Group
vgcreate vg-data /dev/sdb1 /dev/sdc1  # Cr√©er VG
vgextend vg-data /dev/sdd    # Ajouter PV au VG existant

# 4. Cr√©ation Logical Volumes
lvcreate -n lv-home -L 20G vg-data     # Taille fixe
lvcreate -n lv-var -l 50%VG vg-data    # Pourcentage VG
lvcreate -n lv-tmp -l 100%FREE vg-data # Tout l'espace restant

# 5. Formatage et montage
mkfs.ext4 /dev/vg-data/lv-home
mount /dev/vg-data/lv-home /home
```

### Gestion LVM Avanc√©e
```bash
# Informations et monitoring
pvs, vgs, lvs               # Vue r√©sum√©e
pvdisplay, vgdisplay, lvdisplay  # Infos d√©taill√©es
vgdisplay -v vg-data        # Avec d√©tails PV/LV

# Redimensionnement
lvextend -L +5G /dev/vg-data/lv-home      # Ajouter 5GB
lvextend -l +100%FREE /dev/vg-data/lv-var # Utiliser tout libre
lvreduce -L 10G /dev/vg-data/lv-tmp       # R√©duire (ATTENTION!)

# Avec redimensionnement filesystem automatique
lvextend -r -L +5G /dev/vg-data/lv-home   # -r = resize fs

# Snapshots (sauvegarde coh√©rente)
lvcreate -s -L 1G -n lv-home-snap /dev/vg-data/lv-home
mount /dev/vg-data/lv-home-snap /mnt/snapshot
lvremove /dev/vg-data/lv-home-snap        # Supprimer snapshot
```

### Suppression LVM (Ordre Important!)
```bash
# 1. D√©monter filesystems
umount /home
umount /var

# 2. Supprimer LV
lvremove /dev/vg-data/lv-home
lvremove /dev/vg-data/lv-var

# 3. Supprimer VG
vgremove vg-data

# 4. Supprimer PV
pvremove /dev/sdb1 /dev/sdc1
```

## üîç D√©tection & Information

### Exploration Hardware
```bash
# P√©riph√©riques blocs
lsblk                        # Arbre p√©riph√©riques (recommand√©)
lsblk -f                     # Avec filesystems et UUID
fdisk -l                     # Liste d√©taill√©e partitions
cat /proc/partitions         # Vue kernel des partitions

# Informations disques
lshw -class disk             # D√©tails hardware disques
hdparm -I /dev/sda           # Informations techniques ATA
smartctl -a /dev/sda         # √âtat SMART du disque
```

### UUID et Labels
```bash
# Identifier uniquement
blkid                        # UUID et labels tous p√©riph√©riques
blkid /dev/sda1              # Infos partition sp√©cifique
ls -l /dev/disk/by-uuid/     # Liens par UUID
ls -l /dev/disk/by-label/    # Liens par label

# Attribuer labels
e2label /dev/sda1 "MyData"   # Label ext2/3/4
xfs_admin -L "MyData" /dev/sda1  # Label XFS
```

### Monitoring Utilisation
```bash
# Espace disque
df -h                        # Utilisation filesystems
df -i                        # Utilisation inodes
du -sh /var/log              # Taille dossier
ncdu /                       # Interface interactive (si install√©)

# I/O en temps r√©el
iotop                        # Top des processus I/O
iostat -x 1                  # Statistiques I/O d√©taill√©es
```

## üíø P√©riph√©riques Virtuels

### Loop Devices
```bash
# Cr√©er et monter image disque
dd if=/dev/zero of=disk.img bs=1M count=100  # Cr√©er image 100MB
mkfs.ext4 disk.img           # Formater image
losetup /dev/loop0 disk.img  # Associer loop device
mount /dev/loop0 /mnt        # Monter

# Gestion automatique
mount -o loop disk.img /mnt  # Mount avec loop automatique
losetup -a                   # Lister loop devices actifs
losetup -d /dev/loop0        # D√©tacher loop device
```

### Device Mapper
```bash
# Lister mappings actifs
dmsetup ls                   # Liste devices mapp√©s
dmsetup info vg-data-lv-home # Infos device sp√©cifique
dmsetup table vg-data-lv-home # Table de mapping

# √âtats devices
dmsetup status               # √âtat tous devices
ls -l /dev/mapper/           # Devices disponibles
```

## üîÑ Migration & Sauvegarde

### Clonage Disques
```bash
# Clonage complet (secteur par secteur)
dd if=/dev/sda of=/dev/sdb bs=4M status=progress conv=fsync

# Clonage avec r√©cup√©ration erreurs
ddrescue /dev/sda /dev/sdb /tmp/rescue.log

# Image de sauvegarde
dd if=/dev/sda1 of=/backup/sda1.img bs=4M
gzip /backup/sda1.img        # Compression

# Restauration
gunzip -c /backup/sda1.img.gz | dd of=/dev/sda1 bs=4M
```

### Sauvegarde LVM
```bash
# Snapshot pour backup coh√©rent
lvcreate -s -L 2G -n backup-snap /dev/vg-data/lv-home
dd if=/dev/vg-data/backup-snap of=/backup/home.img bs=4M
lvremove /dev/vg-data/backup-snap

# Export/Import VG (migration)
vgexport vg-data             # D√©sactiver VG
vgimport vg-data             # R√©activer VG (autre machine)
```

## ‚ö° D√©tection Hardware Dynamique

### Hot-plug Detection
```bash
# Forcer scan nouveaux disques SCSI
echo "- - -" > /sys/class/scsi_host/host0/scan
echo "- - -" > /sys/class/scsi_host/host1/scan

# Rescan partition table
partprobe /dev/sdb           # Relire partitions
udevadm settle               # Attendre fin traitement udev

# Informations udev
udevadm info --query=all --name=/dev/sda
udevadm monitor              # Monitoring √©v√©nements temps r√©el
```

### USB & Removable Media
```bash
# Informations USB
lsusb                        # Lister p√©riph√©riques USB
usb-devices                  # D√©tails p√©riph√©riques USB
dmesg | grep -i usb          # Messages kernel USB

# Montage s√©curis√© amovibles
udisksctl mount -b /dev/sdb1 # Montage utilisateur (sans sudo)
udisksctl unmount -b /dev/sdb1  # D√©montage s√©curis√©
```

## üö® R√©cup√©ration & D√©pannage

### R√©cup√©ration Partitions
```bash
# Tenter r√©cup√©ration table partitions
testdisk /dev/sdb            # Outil interactif r√©cup√©ration
photorec /dev/sdb            # R√©cup√©ration fichiers par signatures

# V√©rification int√©grit√©
badblocks -v /dev/sdb        # Test blocs d√©fectueux (lecture)
badblocks -w -v /dev/sdb     # Test destructif (√©criture)
```

### Debug LVM
```bash
# Mode debug LVM
vgchange -ay --verbose vg-data  # Activer VG avec debug
lvchange -ay --verbose /dev/vg-data/lv-home

# Reconstruction m√©tadonn√©es
vgcfgrestore -l vg-data      # Lister sauvegardes config
vgcfgrestore vg-data         # Restaurer derni√®re config
pvscan --cache               # Reconstruire cache PV
```

### Situations d'Urgence
```bash
# Activation forc√©e LVM
vgchange -ay --partial vg-data  # Activer m√™me si PV manquant
lvchange -ay --partial /dev/vg-data/lv-home

# Mode read-only filesystem
mount -o remount,ro /         # Basculer en lecture seule
fsck.ext4 -f /dev/sda1       # V√©rifier filesystem
mount -o remount,rw /        # Rebascule en √©criture
```

## üí° Bonnes Pratiques

### Planification Stockage
- ‚úÖ **Utiliser GPT** pour nouveaux syst√®mes
- ‚úÖ **LVM par d√©faut** pour flexibilit√© future
- ‚úÖ **S√©parer** `/`, `/home`, `/var` sur LV diff√©rents
- ‚úÖ **Pr√©voir snapshots** LVM pour sauvegardes coh√©rentes
- ‚úÖ **Monitoring** SMART des disques

### S√©curit√© & Performance
- ‚úÖ **UUID dans fstab** pour stabilit√©
- ‚úÖ **Alignment** partitions (d√©but sur 1MiB)
- ‚úÖ **R√©server espace** LVM pour snapshots (10-20%)
- ‚úÖ **Labels explicites** pour identification
- ‚úÖ **Documentation** architecture de stockage

### Maintenance R√©guli√®re
- ‚úÖ **V√©rifier** √©tat SMART mensuel
- ‚úÖ **Tester** proc√©dures restauration
- ‚úÖ **Nettoyer** snapshots anciens
- ‚úÖ **Surveiller** utilisation espace
- ‚úÖ **Planifier** extension avant saturation

---
**üí° Memo** : LVM = PV‚ÜíVG‚ÜíLV, toujours UUID dans fstab, snapshots pour backup coh√©rents !



