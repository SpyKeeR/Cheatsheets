# üíæ Filesystems Linux ‚Äî Aide-m√©moire

## üèóÔ∏è Concepts Fondamentaux

### Structure Filesystem
```
Filesystem = Structure organis√©e pour stockage donn√©es
‚îú‚îÄ‚îÄ Superbloc : M√©tadonn√©es vitales FS
‚îú‚îÄ‚îÄ Inodes : M√©tadonn√©es fichiers/dossiers
‚îú‚îÄ‚îÄ Blocs donn√©es : Contenu r√©el
‚îî‚îÄ‚îÄ Tables allocation : Gestion espace libre
```

### Types de Donn√©es
| √âl√©ment | Contenu | Localisation |
|---------|---------|--------------|
| **Superbloc** | Config FS, taille, limites | D√©but partition + copies |
| **Inode** | M√©tadonn√©es fichier | Table inodes |
| **Bloc donn√©es** | Contenu fichier/dossier | Zone donn√©es |
| **Bloc indirection** | Pointeurs gros fichiers | Zone donn√©es |

## üìã Types de Filesystems

### Comparatif Filesystems Linux
| FS | Journalisation | Taille Max Fichier | Taille Max FS | Usage |
|----|----------------|-------------------|---------------|-------|
| **ext2** | ‚ùå | 2 TiB | 32 TiB | Legacy, /boot |
| **ext3** | ‚úÖ | 2 TiB | 32 TiB | Transition |
| **ext4** | ‚úÖ | 16 TiB | 1 EiB | Standard serveurs |
| **XFS** | ‚úÖ | 8 EiB | 8 EiB | Gros volumes |
| **Btrfs** | ‚úÖ | 16 EiB | 16 EiB | Snapshots, RAID |
| **ZFS** | ‚úÖ | 16 EiB | 256 ZiB | Int√©grit√© donn√©es |

### √âvolution EXT
```
EXT2 (1993) ‚Üí EXT3 (2001) ‚Üí EXT4 (2008)
     ‚Üì              ‚Üì              ‚Üì
 Pas journal   + Journal    + Extents
 Simple        Robuste     Performance
```

## üîß Gestion Filesystems

### Cr√©ation & Formatage
```bash
# Formatage standard
mkfs.ext4 /dev/sdc1              # EXT4 basique
mkfs.xfs /dev/sdc1               # XFS
mkfs.btrfs /dev/sdc1             # Btrfs

# Options avanc√©es EXT4
mkfs.ext4 -L "MonDisk" /dev/sdc1              # Avec label
mkfs.ext4 -b 4096 -i 16384 /dev/sdc1         # Taille bloc + ratio inodes
mkfs.ext4 -m 1 /dev/sdc1                     # 1% r√©serv√© root (vs 5% d√©faut)
mkfs.ext4 -E lazy_itable_init=0 /dev/sdc1    # Init imm√©diate (plus lent)

# V√©rification avant formatage
lsblk /dev/sdc                   # V√©rifier partitions
wipefs -a /dev/sdc1              # Nettoyer signatures FS pr√©c√©dentes
```

### Informations Filesystem
```bash
# Identification
blkid                            # UUID, LABEL, TYPE tous FS
blkid /dev/sdc1                  # Infos partition sp√©cifique
lsblk -f                         # Arbre + infos FS
findmnt                          # Points montage actifs

# D√©tails EXT2/3/4
tune2fs -l /dev/sdc1             # Infos compl√®tes superbloc
dumpe2fs /dev/sdc1               # D√©tails techniques
e2fsck -n /dev/sdc1              # Check read-only

# √âtat utilisation
df -h                            # Espace utilis√© human-readable
df -i                            # Utilisation inodes
du -sh /path                     # Taille dossier
```

## üîß Configuration Filesystem

### Tuning EXT4
```bash
# Labeling
tune2fs -L "NouveauLabel" /dev/sdc1

# Param√®tres montage par d√©faut
tune2fs -o journal_data_writeback /dev/sdc1   # Performance (moins s√ªr)
tune2fs -o ^journal_data_ordered /dev/sdc1    # D√©sactiver option

# V√©rifications automatiques
tune2fs -c 30 /dev/sdc1          # V√©rif tous les 30 montages
tune2fs -i 1m /dev/sdc1          # V√©rif tous les mois
tune2fs -c 0 -i 0 /dev/sdc1      # D√©sactiver v√©rifs auto

# R√©servation espace root
tune2fs -m 1 /dev/sdc1           # 1% r√©serv√© (vs 5% d√©faut)
tune2fs -r 1024 /dev/sdc1        # 1024 blocs r√©serv√©s
```

### Redimensionnement
```bash
# Agrandir (online pour ext4)
resize2fs /dev/sdc1              # Utilise tout l'espace disponible
resize2fs /dev/sdc1 10G          # Taille sp√©cifique

# R√©duire (OFFLINE obligatoire)
umount /mnt/disk
e2fsck -f /dev/sdc1              # V√©rification obligatoire
resize2fs /dev/sdc1 5G           # R√©duire FS AVANT partition
# Puis r√©duire partition avec fdisk/parted
```

## üóÇÔ∏è Structure Inode

### M√©tadonn√©es Inode
```bash
# Contenu inode
stat fichier.txt                 # Afficher m√©tadonn√©es compl√®tes
ls -li fichier.txt               # Num√©ro inode + d√©tails

# Composants inode
Type fichier     : - d l b c p s (regular, directory, link, block, char, pipe, socket)
Permissions      : rwxrwxrwx (user, group, other)
Liens hardlinks  : Nombre r√©f√©rences vers m√™me inode
UID/GID          : Propri√©taire / Groupe
Taille           : Octets
Timestamps       : atime, mtime, ctime
Pointeurs blocs  : Vers donn√©es (direct + indirect)
```

### Types de Blocs
| Type | Description | Usage |
|------|-------------|-------|
| **Direct** | Pointeur vers bloc donn√©es | Petits fichiers (<48KB) |
| **Indirect simple** | Pointeur vers bloc de pointeurs | Fichiers moyens |
| **Indirect double** | Pointeur vers pointeurs de pointeurs | Gros fichiers |
| **Indirect triple** | 3 niveaux indirection | Tr√®s gros fichiers |

## üìÅ Montage & fstab

### Montage Manuel
```bash
# Montage basique
mount /dev/sdc1 /mnt             # Type auto-d√©tect√©
mount -t ext4 /dev/sdc1 /mnt     # Type explicite
mount -L "MonLabel" /mnt         # Par label
mount UUID="123-456" /mnt        # Par UUID (recommand√©)

# Options montage courantes
mount -o ro /dev/sdc1 /mnt       # Lecture seule
mount -o rw,noatime /dev/sdc1 /mnt  # R/W sans mise √† jour atime
mount -o remount,ro /mnt         # Changer options sans d√©monter

# D√©montage
umount /mnt                      # Par point montage
umount /dev/sdc1                 # Par p√©riph√©rique
umount -l /mnt                   # Lazy (d√©monte quand plus utilis√©)
fuser -km /mnt                   # Forcer fermeture processus utilisant
```

### Configuration fstab
```bash
# Structure /etc/fstab
# <source> <mountpoint> <fstype> <options> <dump> <pass>

# Exemples pratiques
UUID=123-456-789 /home ext4 defaults,noatime 0 2
LABEL=DataDisk /data xfs defaults,noatime 0 2
/dev/sdb1 none swap sw 0 0
tmpfs /tmp tmpfs defaults,size=1G 0 0

# Options communes
defaults     # rw,suid,dev,exec,auto,nouser,async
noatime      # Pas MAJ temps acc√®s (performance)
relatime     # MAJ atime si plus ancien que mtime
user         # Utilisateurs peuvent monter
nouser       # Seul root peut monter (d√©faut)
auto         # Montage automatique au boot
noauto       # Montage manuel uniquement
```

### Options Montage Avanc√©es
```bash
# Performance
noatime,nodiratime              # Pas MAJ temps acc√®s
data=writeback                  # Performance max (moins s√ªr)
data=ordered                    # Compromis (d√©faut ext4)
data=journal                    # S√©curit√© max (plus lent)

# S√©curit√©
noexec                         # Pas ex√©cution binaires
nosuid                         # Ignorer bit SUID
nodev                          # Pas fichiers p√©riph√©riques

# R√©seau
_netdev                        # Attendre r√©seau (NFS, CIFS)
```

## üîç Diagnostic & Maintenance

### V√©rification Filesystem
```bash
# Check filesystem (OFFLINE)
fsck /dev/sdc1                  # Auto-d√©tection type
fsck.ext4 /dev/sdc1            # Type sp√©cifique
e2fsck -f /dev/sdc1            # Forcer v√©rification compl√®te
e2fsck -p /dev/sdc1            # R√©paration automatique
e2fsck -n /dev/sdc1            # Read-only (pas modifications)

# V√©rification avanc√©e
badblocks -v /dev/sdc1         # Test blocs d√©fectueux
badblocks -w /dev/sdc1         # Test destructif (reformate!)
```

### Analyse Utilisation
```bash
# Espace disque
df -h                          # R√©sum√© utilisation
df -i                          # Utilisation inodes
du -sh /*                      # Taille r√©pertoires racine
ncdu /                         # Interface interactive (si install√©)

# Fichiers volumineux
find / -size +100M -type f     # Fichiers >100MB
find / -size +1G -type f -exec ls -lh {} \;  # Fichiers >1GB avec d√©tails

# Inodes
find / -type f | wc -l         # Compter fichiers totaux
tune2fs -l /dev/sdc1 | grep -i inode  # Stats inodes
```

### Monitoring Temps R√©el
```bash
# I/O en cours
iotop                          # Monitoring I/O par processus
iostat -x 1                    # Stats I/O d√©taill√©es
watch -n 1 'df -h'             # Surveillance espace disque

# Processus utilisant filesystem
lsof /mnt                      # Fichiers ouverts sur /mnt
fuser -v /mnt                  # Processus utilisant /mnt
```

## üö® Recovery & Troubleshooting

### Probl√®mes Courants
| Probl√®me | Sympt√¥me | Solution |
|----------|----------|----------|
| **FS corrompu** | Erreurs I/O, montage √©choue | `e2fsck -f /dev/sdX1` |
| **Inodes pleins** | "No space" avec espace libre | Supprimer fichiers ou agrandir |
| **Blocs d√©fectueux** | Erreurs lecture/√©criture | `badblocks` + `e2fsck -c` |
| **Montage √©choue** | Erreur montage | V√©rifier fstab, fsck |

### Recovery Avanc√©
```bash
# Superbloc de secours
dumpe2fs /dev/sdc1 | grep -i superblock  # Localiser backups
e2fsck -b 32768 /dev/sdc1      # Utiliser superbloc backup
mke2fs -n /dev/sdc1            # Lister superblocs sans formater

# Recovery fichiers supprim√©s (ext4)
debugfs /dev/sdc1              # Interface debug
# > lsdel                      # Lister inodes supprim√©s
# > dump <inode> /tmp/recovered # R√©cup√©rer fichier

# Clonage partition
dd if=/dev/sdc1 of=/dev/sdd1 conv=noerror,sync  # Clone avec erreurs
ddrescue /dev/sdc1 /dev/sdd1   # Recovery avanc√© (si install√©)
```

## üîÑ Filesystems Sp√©cialis√©s

### Filesystems Temporaires
```bash
# tmpfs (RAM)
tmpfs /tmp tmpfs defaults,size=1G,mode=1777 0 0     # Dans fstab
mount -t tmpfs -o size=512M tmpfs /tmp              # Manuel

# ramfs (RAM sans swap)
mount -t ramfs ramfs /mnt       # Pas de limite taille (danger!)
```

### Filesystems R√©seau
```bash
# NFS
mount -t nfs server:/export /mnt
# Dans fstab: server:/export /mnt nfs defaults,_netdev 0 0

# CIFS/SMB
mount -t cifs //server/share /mnt -o username=user,password=pass
# Dans fstab: //server/share /mnt cifs credentials=/etc/cifs-creds,_netdev 0 0
```

### Filesystems Overlay
```bash
# OverlayFS (Docker/containers)
mount -t overlay overlay -o lowerdir=/lower,upperdir=/upper,workdir=/work /merged
```

## üí° Bonnes Pratiques

### Performance
- ‚úÖ **noatime** sur filesystems hautes performances
- ‚úÖ **Taille blocs** adapt√©e : 4KB standard, 64KB+ gros fichiers
- ‚úÖ **R√©servation root** : 1% au lieu de 5% sur gros volumes
- ‚úÖ **XFS** pour tr√®s gros volumes/fichiers

### S√©curit√© & Maintenance
- ‚úÖ **UUID** dans fstab (stabilit√©)
- ‚úÖ **fsck p√©riodique** sur filesystems critiques
- ‚úÖ **Monitoring** espace disque et inodes
- ‚úÖ **Snapshots** avant modifications importantes (LVM/Btrfs)

### Organisation
- ‚úÖ **S√©parer** `/`, `/home`, `/var` sur partitions distinctes
- ‚úÖ **Labels explicites** pour identification rapide
- ‚úÖ **Documentation** des montages non-standard
- ‚úÖ **Tests recovery** r√©guliers sur syst√®mes critiques

---
**üí° Memo** : UUID dans fstab, fsck avant resize, noatime pour performances, toujours d√©monter avant fsck !
