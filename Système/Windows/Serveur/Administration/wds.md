# üöÄ D√©ploiement OS Windows ‚Äî WDS, MDT & Modern Deployment

## üèóÔ∏è Solutions de D√©ploiement

### Comparatif Technologies Microsoft
| Solution | Complexit√© | Scalabilit√© | Automation | Use Case |
|----------|------------|-------------|------------|----------|
| **WDS** | Faible | Moyenne | Limit√©e | PXE boot basique |
| **MDT** | Moyenne | √âlev√©e | Compl√®te | D√©ploiement automatis√© |
| **ConfigMgr** | √âlev√©e | Tr√®s √©lev√©e | Compl√®te | Enterprise lifecycle |
| **Autopilot** | Faible | √âlev√©e | Cloud | Modern workplace |
| **WinGet** | Faible | Moyenne | Apps | Package management |

### Technologies Alternatives
- **FOG Project** : Open source, l√©ger
- **Clonezilla** : Clone disk-to-disk
- **SmartDeploy** : Commercial, user-friendly
- **Acronis Snap Deploy** : Enterprise imaging

## üñ•Ô∏è Windows Deployment Services (WDS)

### Architecture & Pr√©requis
```
Infrastructure Requise:
‚îú‚îÄ‚îÄ Active Directory (recommand√©)
‚îú‚îÄ‚îÄ DHCP Server (obligatoire)
‚îú‚îÄ‚îÄ DNS Server (recommand√©)
‚îî‚îÄ‚îÄ Stockage r√©seau suffisant

Services WDS:
‚îú‚îÄ‚îÄ Deployment Server (core)
‚îú‚îÄ‚îÄ Transport Server (PXE/TFTP)
‚îî‚îÄ‚îÄ PXE Server (boot management)
```

### WDS
- R√¥le Windows : PXE boot + h√©bergement `boot.wim` (WinPE) & `install.wim`.  
- Services requis : DHCP (obligatoire), DNS (recommand√©), AD (fortement recommand√©).  
- Modes PXE : DHCP+WDS m√™me serveur (options 66/67) OU DHCP s√©par√© + WDS en ProxyDHCP.  
- Install (PowerShell) : `Install-WindowsFeature -Name WDS -IncludeManagementTools`.  
- Config initiale : choix domaine/hors-domaine, dossier REMINST, mode r√©ponse PXE (autoriser/tarterget).  
- Ajout d'images : importer boot.wim (Images de d√©marrage) puis install.wim (Images d'installation).  
- Pilotes : ajout manuel ou via MDT, organiser par mod√®le.

### ConfigMgr (si enterprise)
- D√©ploiement + patching + inventaire + distribution applis (usage grande infra).

### Types d'images
- Image de partition : snapshot complet (rapide, mat√©riel homog√®ne requis).  
- Image WIM (install.wim) : installation dynamique (flexible, multi-mat√©riel).  
- Choix = homog√©n√©it√© mat√©rielle vs flexibilit√©.

### Capture d'image (workflow)
1. Pr√©parer poste mod√®le ‚Üí `sysprep` (C:\Windows\System32\Sysprep\sysprep.exe).  
2. Cr√©er image de capture li√©e √† une image boot dans WDS.  
3. PXE boot poste ‚Üí lancer assistant de capture ‚Üí envoyer .wim au serveur WDS.

### Unattend.xml (fichiers de r√©ponse)
- WinPE (phase 1) ‚Üí placer `unattend.xml` dans `\\<WDS>\REMINST\WDSClientUnattend`.  
- Install images (phases 2-7) ‚Üí associer le `unattend.xml` √† l'image d'installation (propri√©t√©s image).  
- Outils : WSIM (ADK), PowerShell, √©diteurs GUI.

### PXE flow r√©sum√© (8 √©tapes)
1. Client PXE -> DHCPDISCOVER  
2. DHCPOFFER (DHCP +/- PXE options)  
3. DHCPREQUEST ‚Üí DHCPACK  
4. Client r√©cup√®re option 66/67 (TFTP/boot file)  
5. T√©l√©chargement boot.wim via TFTP/HTTP  
6. WinPE d√©marre ‚Üí ex√©cute s√©quence MDT/WDS  
7. R√©cup√©ration install.wim et installation  
8. Post-install (drivers, apps, join AD, finalisation via unattend)

### Sc√©narios de d√©ploiement
- Bare Metal (nouveau) ‚Äî full OS fresh.  
- R√©installation (wipe & load) ‚Äî r√©parer / conserver donn√©es selon m√©thode.  
- Remplacement (migrate) ‚Äî capture ancien ‚Üí restore sur nouveau.  
- In-place Upgrade ‚Äî upgrade sans formatage.

### WDS / DHCP cohabitation (rappel rapide)
- M√™me serveur : DHCP fournit 66/67 ; WDS n'√©coute pas sur ports DHCP.  
- Serveurs distincts : activer Proxy DHCP sur WDS pour fournir uniquement options PXE.

### Bonnes pratiques (checklist)
- Int√©grer AD, utiliser DNS interne.  
- Stockage images sur disque d√©di√©.  
- Organiser drivers par mod√®le ; utiliser MDT pour injecter drivers.  
- Utiliser unattend.xml pour automatisation compl√®te.  
- Tester capture ‚Üí d√©ploiement sur mod√®les repr√©sentatifs.  
- Mettre en place inventaire & versions d'image (naming / serial : AAAAMMJJ).  
- Sauvegarder r√©pertoire REMINST / backups WDS.  
- Gestion licences Windows + activation KMS/AAD si n√©cessaire.  
- Automatiser via PowerShell / MDT pour reproductibilit√©.

### Commandes utiles (rapides)
- Installer WDS : `Install-WindowsFeature -Name WDS -IncludeManagementTools`  
- Sysprep (local) : lancer `sysprep.exe` ‚Üí Generalize / Shutdown.  
- V√©rifier/importer images : via console WDS / MDT ou scripts PowerShell WDS.

### Installation & Configuration
```powershell
# Installation r√¥le WDS
Install-WindowsFeature -Name WDS -IncludeManagementTools

# Configuration initiale via PowerShell
wdsutil /Initialize-Server /RemInst:"C:\RemoteInstall"
wdsutil /Set-Server /AnswerClients:All

# Ou via GUI
# Server Manager > Add Roles > Windows Deployment Services
```

### Configuration DHCP Integration
```powershell
# M√™me serveur DHCP/WDS
wdsutil /Set-Server /UseDhcpPorts:No /DhcpOption60:Yes

# Serveurs s√©par√©s - Configuration DHCP
netsh dhcp server \\dhcp-server scope 192.168.1.0 set optionvalue 66 STRING "192.168.1.10"  # IP WDS
netsh dhcp server \\dhcp-server scope 192.168.1.0 set optionvalue 67 STRING "boot\\x64\\wdsnbp.com"  # Boot file
```

### Gestion Images
```powershell
# Importer image de d√©marrage
wdsutil /Add-Image /ImageFile:"C:\Sources\boot.wim" /ImageType:Boot

# Importer image d'installation
wdsutil /Add-Image /ImageFile:"C:\Sources\install.wim" /ImageType:Install /ImageGroup:"Windows 11"

# Lister images
wdsutil /Get-AllImages /Show:Images

# Supprimer image
wdsutil /Remove-Image /Image:"Windows 11 Pro" /ImageType:Install /ImageGroup:"Windows 11"
```

### Types d'Images
| Type | Description | Avantages | Inconv√©nients |
|------|-------------|-----------|---------------|
| **Boot Image** | Windows PE pour d√©marrage | Universelle | Taille importante |
| **Install Image** | OS de base | Flexible, multi-hardware | Installation plus lente |
| **Capture Image** | Image personnalis√©e | Pr√©-configur√©e | Hardware sp√©cifique |
| **Discover Image** | PXE alternatif | Contourne limitations DHCP | Configuration manuelle |


### Structure Deployment Share
```
C:\DeploymentShare\
‚îú‚îÄ‚îÄ Applications\              # Applications √† d√©ployer
‚îú‚îÄ‚îÄ Operating Systems\         # Images OS
‚îú‚îÄ‚îÄ Out-of-Box Drivers\       # Pilotes
‚îú‚îÄ‚îÄ Packages\                 # Updates/Language packs
‚îú‚îÄ‚îÄ Task Sequences\           # S√©quences de d√©ploiement
‚îú‚îÄ‚îÄ Selection Profiles\       # Profils de s√©lection
‚îî‚îÄ‚îÄ Boot Images\             # Images de d√©marrage g√©n√©r√©es
```

### Cr√©ation Task Sequence
```powershell
# Via PowerShell MDT
Import-Module "C:\Program Files\Microsoft Deployment Toolkit\bin\MicrosoftDeploymentToolkit.psd1"

New-PSDrive -Name "DS001" -PSProvider MDTProvider -Root "C:\DeploymentShare"

# Importer OS
Import-MDTOperatingSystem -Path "DS001:\Operating Systems" -SourcePath "C:\Sources\Windows11" -DestinationFolder "Windows 11 22H2"

# Cr√©er Task Sequence
Import-MDTTaskSequence -Path "DS001:\Task Sequences" -Name "Deploy Windows 11" -Template "Client.xml" -ID "WIN11" -OperatingSystemPath "DS001:\Operating Systems\Windows 11 22H2"
```

### CustomSettings.ini Configuration
```ini
[Settings]
Priority=Default
Properties=MyCustomProperty

[Default]
OSInstall=Y
SkipCapture=YES
SkipAdminPassword=NO
SkipProductKey=YES
SkipComputerBackup=YES
SkipBitLocker=YES

; Active Directory Join
JoinDomain=domain.local
DomainAdmin=deployer
DomainAdminDomain=domain.local
DomainAdminPassword=P@ssw0rd!

; Time Zone
TimeZoneName=Romance Standard Time

; Regional Settings
KeyboardLocale=040c:0000040c
UserLocale=fr-FR
UILanguage=fr-FR

; Applications
MandatoryApplications001={GUID-App1}
MandatoryApplications002={GUID-App2}

; Drivers
DriverSelectionProfile=All Drivers

; Logging
SLShare=\\server\logs$
SLShareDynamicLogging=\\server\logs$\%OSDComputerName%
```

### Bootstrap.ini Configuration
```ini
[Settings]
Priority=Default

[Default]
DeployRoot=\\server\DeploymentShare$
SkipBDDWelcome=YES

; Credentials for deployment share access
UserID=deployer
UserPassword=P@ssw0rd!
UserDomain=domain.local

; Skip wizard pages
SkipTaskSequence=NO
SkipComputerName=NO
SkipDomainMembership=YES
SkipUserData=YES
SkipApplications=YES
SkipBitLocker=YES
SkipSummary=YES
SkipRoles=YES
SkipCapture=YES
SkipFinalSummary=NO
```


## üåê Modern Deployment (Cloud)

### Windows Autopilot
```powershell
# Installation module Autopilot
Install-Module -Name WindowsAutoPilotIntune -Force

# R√©cup√©ration Hardware Hash
Get-WindowsAutoPilotInfo -OutputFile "C:\Autopilot\devices.csv"

# Import dans Intune via Graph API
Connect-MSGraph
Import-AutoPilotCSV -csvFile "C:\Autopilot\devices.csv"
```

### Configuration Autopilot Profile
```json
{
    "displayName": "Corporate Deployment",
    "description": "Standard corporate deployment profile",
    "language": "fr-FR",
    "locale": "fr-FR",
    "timezone": "Romance Standard Time",
    "hideEULA": true,
    "hidePrivacySettings": true,
    "hideChangeAccountOpts": true,
    "skipKeyboardSelectionPage": true,
    "deviceNameTemplate": "CORP-%SERIAL%",
    "enableWhiteGlove": true,
    "outOfBoxExperienceSettings": {
        "hidePrivacySettings": true,
        "hideEULA": true,
        "userType": "standard"
    }
}
```

### WinGet Package Management
```yaml
# winget-config.yaml
applications:
  - id: Microsoft.VisualStudioCode
    source: winget
  - id: Google.Chrome
    source: winget
  - id: 7zip.7zip
    source: winget
  - id: Adobe.Acrobat.Reader.64-bit
    source: winget

# Deployment script
winget import -i winget-config.yaml --accept-package-agreements --accept-source-agreements
```

## üìä Monitoring & Logging

### WDS Event Logs
| Log Location | Event IDs | Description |
|--------------|-----------|-------------|
| **Microsoft-Windows-Deployment-Services-Diagnostics/Operational** | 4097-4115 | Client deployment events |
| **System** | 7001,7002 | WDS service events |
| **Microsoft-Windows-Deployment-Services/Operational** | 513,515 | Image serving events |
| **Application** | Various | MDT task sequence logs |

## üõ†Ô∏è Troubleshooting

### Diagnostics PXE Boot
```bash
# Flow PXE debugging
1. DHCP Discovery    -> V√©rifier r√©ponse DHCP
2. PXE Options       -> Contr√¥ler options 66/67
3. TFTP Download     -> Tester connectivit√© TFTP
4. Boot Image Load   -> V√©rifier int√©grit√© boot.wim
5. WinPE Start       -> Logs WinPE (X:\Windows\Temp\SMSTSLog)
```

### Commandes Diagnostics
```powershell
# Test connectivit√© WDS
Test-NetConnection -ComputerName "wds-server" -Port 69   # TFTP
Test-NetConnection -ComputerName "wds-server" -Port 4011 # PXE

# V√©rification services WDS
Get-Service WDSServer, WDSUTIL

# Logs d√©taill√©s WDS
wdsutil /Set-Server /Verbose:Yes

# Test DHCP options
ipconfig /all  # V√©rifier options DHCP re√ßues
```

### Probl√®mes Courants
| Probl√®me | Cause Probable | Solution |
|----------|----------------|----------|
| **PXE-E53** | DHCP/PXE config | V√©rifier options 66/67 |
| **Boot loop** | Image corrompue | Re-capturer/importer image |
| **Driver missing** | Pilotes absents | Ajouter drivers out-of-box |
| **Domain join fail** | Credentials/DNS | V√©rifier compte service |
| **Slow deployment** | R√©seau/stockage | Optimiser infra r√©seau |

## üìã Best Practices & Security

### S√©curisation D√©ploiement
```powershell
# S√©curiser WDS
# 1. Authentification requise
wdsutil /Set-Server /AnswerClients:Known

# 2. Approbation manuelle
wdsutil /Set-Server /NewMachineNamingPolicy:%Username%#

# 3. Limitation par groupe AD
# Via WDS Console > Properties > Client > Enable unattended installation
```

### Architecture Recommand√©e
```
Production Deployment Architecture:
‚îú‚îÄ‚îÄ WDS Server (Dedicated)
‚îÇ   ‚îú‚îÄ‚îÄ RAID 1 System
‚îÇ   ‚îú‚îÄ‚îÄ RAID 5/10 Storage (Images)
‚îÇ   ‚îî‚îÄ‚îÄ 1Gbps Network minimum
‚îú‚îÄ‚îÄ MDT Server (Can be same as WDS)
‚îú‚îÄ‚îÄ File Server (Drivers/Apps)
‚îú‚îÄ‚îÄ DHCP Server (Redundant)
‚îî‚îÄ‚îÄ Network Infrastructure
    ‚îú‚îÄ‚îÄ Gigabit switches
    ‚îú‚îÄ‚îÄ VLAN segmentation
    ‚îî‚îÄ‚îÄ QoS for deployment traffic
```

### Checklist D√©ploiement
- [ ] Infrastructure r√©seau valid√©e (DHCP/DNS/AD)
- [ ] Stockage suffisant calcul√© (images + logs)
- [ ] Sauvegarde REMINST configur√©e
- [ ] Tests sur mat√©riel repr√©sentatif effectu√©s
- [ ] Documentation proc√©dures maintenue
- [ ] Scripts automation versionn√©s
- [ ] Monitoring et alerting en place
- [ ] Formation √©quipe effectu√©e
- [ ] Plan de rollback d√©fini
- [ ] Licences Windows v√©rifi√©es
